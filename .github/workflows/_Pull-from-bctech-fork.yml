name: Pull from BCTech Fork

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch:
    # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

defaults:
  run:
    shell: pwsh

env:
  SYNC_BRANCH: pull-from-bctech-fork

jobs:
  validate-config:
    runs-on: ubuntu-latest
    steps:
      - name: Validate required secrets and variables
        shell: pwsh
        env:
          SECRET_FORKREPOPAT: ${{ secrets.FORKREPOPAT }}
          VAR_FORK_REPO: ${{ vars.FORK_REPO }}
          VAR_BCTECH_SOURCE_FOLDER: ${{ vars.BCTECH_SOURCE_FOLDER }}
          VAR_LOCAL_FOLDER: ${{ vars.LOCAL_FOLDER }}
        run: |
          $errors = @()
          
          # Check secrets
          if ([string]::IsNullOrWhiteSpace($env:SECRET_FORKREPOPAT)) {
            $errors += "Secret 'FORKREPOPAT' is not set"
          }
          
          # Check variables
          if ([string]::IsNullOrWhiteSpace($env:VAR_FORK_REPO)) {
            $errors += "Variable 'FORK_REPO' is not set"
          }
          if ([string]::IsNullOrWhiteSpace($env:VAR_BCTECH_SOURCE_FOLDER)) {
            $errors += "Variable 'BCTECH_SOURCE_FOLDER' is not set"
          }
          if ([string]::IsNullOrWhiteSpace($env:VAR_LOCAL_FOLDER)) {
            $errors += "Variable 'LOCAL_FOLDER' is not set"
          }
          
          if ($errors.Count -gt 0) {
            Write-Host "::error::Missing required configuration:"
            $errors | ForEach-Object { Write-Host "::error::  - $_" }
            exit 1
          }
          
          Write-Host "All required secrets and variables are configured"

  sync:
    runs-on: ubuntu-latest
    needs: validate-config
    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4
        with:
          path: target-repo
          token: ${{ secrets.FORKREPOPAT }}
          fetch-depth: 0

      - name: Checkout BCTech fork repository
        uses: actions/checkout@v4
        with:
          repository: ${{ vars.FORK_REPO }}
          path: source-repo
          sparse-checkout: |
            ${{ vars.BCTECH_SOURCE_FOLDER }}
          sparse-checkout-cone-mode: false

      - name: Debug - List checked out contents
        run: |
          Write-Host "Contents of source-repo:"
          Get-ChildItem -Path source-repo -Recurse -Depth 3 | ForEach-Object {
            Write-Host $_.FullName
          }
          Write-Host ""
          Write-Host "Looking for: source-repo/${{ vars.BCTECH_SOURCE_FOLDER }}"
          Write-Host "Path exists: $(Test-Path 'source-repo/${{ vars.BCTECH_SOURCE_FOLDER }}')"

      - name: Get source commit info
        id: source-info
        run: |
          Set-Location source-repo
          $commitSha = git rev-parse HEAD
          $commitShort = git rev-parse --short HEAD
          $commitMsg = git log -1 --pretty=%s
          "commit_sha=$commitSha" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "commit_short=$commitShort" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "commit_msg=$commitMsg" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Create or update sync branch
        run: |
          Set-Location target-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if branch exists remotely
          $branchExists = git ls-remote --heads origin ${{ env.SYNC_BRANCH }} | Measure-Object
          if ($branchExists.Count -gt 0) {
            git fetch origin ${{ env.SYNC_BRANCH }}
            git checkout ${{ env.SYNC_BRANCH }}
            git reset --hard origin/main
          } else {
            git checkout -B ${{ env.SYNC_BRANCH }}
          }

      - name: Sync folder
        run: |
          $targetFolder = "${{ vars.LOCAL_FOLDER }}"
          $sourceFolder = "${{ vars.BCTECH_SOURCE_FOLDER }}"
          
          # Remove existing folder in target (if exists)
          if (Test-Path "target-repo/$targetFolder") {
            Remove-Item -Recurse -Force "target-repo/$targetFolder"
          }
          
          # Copy the folder from source to target
          $sourcePath = "source-repo/$sourceFolder"
          if (Test-Path $sourcePath) {
            Copy-Item -Recurse $sourcePath "target-repo/$targetFolder"
            Write-Host "Folder synced successfully"
          } else {
            Write-Error "Source folder not found: $sourcePath"
            exit 1
          }

      - name: Check for changes
        id: changes
        run: |
          Set-Location target-repo
          git add -A
          $hasChanges = (git diff --staged --name-only | Measure-Object).Count -gt 0
          if ($hasChanges) {
            "has_changes=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            Write-Host "Changes detected"
          } else {
            "has_changes=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            Write-Host "No changes detected"
          }

      - name: Commit and push to sync branch
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          Set-Location target-repo
          $commitShort = "${{ steps.source-info.outputs.commit_short }}"
          git commit -m "Sync ${{ vars.LOCAL_FOLDER }} from ${{ vars.FORK_REPO }} ($commitShort)"
          git push origin ${{ env.SYNC_BRANCH }} --force

      - name: Create or update PR
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.FORKREPOPAT }}
        run: |
          Set-Location target-repo
          
          $forkRepo = "${{ vars.FORK_REPO }}"
          $commitSha = "${{ steps.source-info.outputs.commit_sha }}"
          $commitShort = "${{ steps.source-info.outputs.commit_short }}"
          $commitMsg = "${{ steps.source-info.outputs.commit_msg }}"
          
          $prBody = @"
          ## Sync from $forkRepo
          
          This PR syncs the ${{ vars.LOCAL_FOLDER }} folder from [$forkRepo](https://github.com/$forkRepo).
          
          **Source commit:** [``$commitShort``](https://github.com/$forkRepo/commit/$commitSha)
          **Commit message:** $commitMsg
          
          ---
          *This PR is automatically created and updated by the sync workflow.*
          "@
          
          # Check if PR already exists
          $existingPr = gh pr list --head "${{ env.SYNC_BRANCH }}" --json number --jq '.[0].number' 2>$null
          
          if ($existingPr) {
            Write-Host "PR #$existingPr already exists, updating..."
            gh pr edit $existingPr --body $prBody
          } else {
            Write-Host "Creating new PR"
            gh pr create `
              --head "${{ env.SYNC_BRANCH }}" `
              --base "main" `
              --title "Sync ${{ vars.LOCAL_FOLDER }} from $forkRepo" `
              --body $prBody
          }
