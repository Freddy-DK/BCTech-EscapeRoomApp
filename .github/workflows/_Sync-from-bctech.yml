name: Sync EscapeRoomApp from BCTech

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch:
    # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

defaults:
  run:
    shell: pwsh

env:
  SYNC_BRANCH: sync-from-bctech

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4
        with:
          path: target-repo
          token: ${{ secrets.FORKREPOPAT }}
          fetch-depth: 0

      - name: Checkout BCTech repository
        uses: actions/checkout@v4
        with:
          repository: microsoft/BCTech
          path: source-repo
          sparse-checkout: |
            non production apps/EscapeRoomApp
          sparse-checkout-cone-mode: false

      - name: Get source commit info
        id: source-info
        run: |
          Set-Location source-repo
          $commitSha = git rev-parse HEAD
          $commitShort = git rev-parse --short HEAD
          $commitMsg = git log -1 --pretty=%s
          "commit_sha=$commitSha" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "commit_short=$commitShort" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "commit_msg=$commitMsg" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Create or update sync branch
        run: |
          Set-Location target-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if branch exists remotely
          $branchExists = git ls-remote --heads origin ${{ env.SYNC_BRANCH }} | Measure-Object
          if ($branchExists.Count -gt 0) {
            git fetch origin ${{ env.SYNC_BRANCH }}
            git checkout ${{ env.SYNC_BRANCH }}
            git reset --hard origin/main
          } else {
            git checkout -B ${{ env.SYNC_BRANCH }}
          }

      - name: Sync folder
        run: |
          # Remove existing EscapeRoomApp folder in target (if exists)
          if (Test-Path "target-repo/EscapeRoomApp") {
            Remove-Item -Recurse -Force "target-repo/EscapeRoomApp"
          }
          
          # Copy the folder from source to target
          $sourcePath = "source-repo/non production apps/EscapeRoomApp"
          if (Test-Path $sourcePath) {
            Copy-Item -Recurse $sourcePath "target-repo/EscapeRoomApp"
            Write-Host "Folder synced successfully"
          } else {
            Write-Error "Source folder not found!"
            exit 1
          }

      - name: Check for changes
        id: changes
        run: |
          Set-Location target-repo
          git add -A
          $hasChanges = (git diff --staged --name-only | Measure-Object).Count -gt 0
          if ($hasChanges) {
            "has_changes=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            Write-Host "Changes detected"
          } else {
            "has_changes=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            Write-Host "No changes detected"
          }

      - name: Commit and push to sync branch
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          Set-Location target-repo
          $commitShort = "${{ steps.source-info.outputs.commit_short }}"
          git commit -m "Sync EscapeRoomApp from microsoft/BCTech ($commitShort)"
          git push origin ${{ env.SYNC_BRANCH }} --force

      - name: Create or update PR
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.FORKREPOPAT }}
        run: |
          Set-Location target-repo
          
          $commitSha = "${{ steps.source-info.outputs.commit_sha }}"
          $commitShort = "${{ steps.source-info.outputs.commit_short }}"
          $commitMsg = "${{ steps.source-info.outputs.commit_msg }}"
          
          $prBody = @"
          ## Sync from microsoft/BCTech
          
          This PR syncs the EscapeRoomApp folder from [microsoft/BCTech](https://github.com/microsoft/BCTech).
          
          **Source commit:** [``$commitShort``](https://github.com/microsoft/BCTech/commit/$commitSha)
          **Commit message:** $commitMsg
          
          ---
          *This PR is automatically created and updated by the sync workflow.*
          "@
          
          # Check if PR already exists
          $existingPr = gh pr list --head "${{ env.SYNC_BRANCH }}" --json number --jq '.[0].number' 2>$null
          
          if ($existingPr) {
            Write-Host "PR #$existingPr already exists, updating..."
            gh pr edit $existingPr --body $prBody
          } else {
            Write-Host "Creating new PR"
            gh pr create `
              --head "${{ env.SYNC_BRANCH }}" `
              --base "main" `
              --title "Sync EscapeRoomApp from microsoft/BCTech" `
              --body $prBody
          }
