name: Push to BCTech Fork

on:
  push:
    branches:
      - main
    paths:
      - 'EscapeRoomApp/**'
  workflow_dispatch:
    # Allow manual trigger

permissions:
  contents: read

defaults:
  run:
    shell: pwsh

env:
  SYNC_BRANCH: push-to-bctech-fork

jobs:
  validate-config:
    runs-on: ubuntu-latest
    steps:
      - name: Validate required secrets and variables
        shell: pwsh
        env:
          SECRET_FORKREPOPAT: ${{ secrets.FORKREPOPAT }}
          VAR_FORK_REPO: ${{ vars.FORK_REPO }}
          VAR_BCTECH_SOURCE_FOLDER: ${{ vars.BCTECH_SOURCE_FOLDER }}
          VAR_LOCAL_FOLDER: ${{ vars.LOCAL_FOLDER }}
        run: |
          $errors = @()
          
          # Check secrets
          if ([string]::IsNullOrWhiteSpace($env:SECRET_FORKREPOPAT)) {
            $errors += "Secret 'FORKREPOPAT' is not set"
          }
          
          # Check variables exist
          if ([string]::IsNullOrWhiteSpace($env:VAR_FORK_REPO)) {
            $errors += "Variable 'FORK_REPO' is not set"
          }
          if ([string]::IsNullOrWhiteSpace($env:VAR_BCTECH_SOURCE_FOLDER)) {
            $errors += "Variable 'BCTECH_SOURCE_FOLDER' is not set"
          }
          if ([string]::IsNullOrWhiteSpace($env:VAR_LOCAL_FOLDER)) {
            $errors += "Variable 'LOCAL_FOLDER' is not set"
          }
          
          # Check for leading/trailing whitespace in variables
          $varsToCheck = @{
            'FORK_REPO' = $env:VAR_FORK_REPO
            'BCTECH_SOURCE_FOLDER' = $env:VAR_BCTECH_SOURCE_FOLDER
            'LOCAL_FOLDER' = $env:VAR_LOCAL_FOLDER
          }
          
          foreach ($var in $varsToCheck.GetEnumerator()) {
            if ($null -ne $var.Value) {
              $trimmed = $var.Value.Trim()
              if ($var.Value -ne $trimmed) {
                $errors += "Variable '$($var.Key)' has leading or trailing whitespace. Value: '$($var.Value)'"
              }
              if ($var.Value -match '[\r\n]') {
                $errors += "Variable '$($var.Key)' contains newline characters"
              }
            }
          }
          
          if ($errors.Count -gt 0) {
            Write-Host "::error::Configuration errors found:"
            $errors | ForEach-Object { Write-Host "::error::  - $_" }
            exit 1
          }
          
          Write-Host "All required secrets and variables are configured correctly"

  create-fork-pr:
    runs-on: ubuntu-latest
    needs: validate-config
    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4
        with:
          path: source-repo

      - name: Checkout BCTech fork
        uses: actions/checkout@v4
        with:
          repository: ${{ vars.FORK_REPO }}
          token: ${{ secrets.FORKREPOPAT }}
          path: bctech-fork
          fetch-depth: 0

      - name: Get commit info
        id: commit-info
        run: |
          Set-Location source-repo
          $commitSha = git rev-parse HEAD
          $commitShort = git rev-parse --short HEAD
          $commitMsg = git log -1 --pretty=%s
          "commit_sha=$commitSha" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "commit_short=$commitShort" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "commit_msg=$commitMsg" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Create branch and copy changes
        run: |
          Set-Location bctech-fork
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Get default branch
          $defaultBranch = git remote show origin | Select-String "HEAD branch:" | ForEach-Object { $_.Line -replace ".*HEAD branch:\s*", "" }
          Write-Host "Default branch: $defaultBranch"
          
          git checkout -B ${{ env.SYNC_BRANCH }} origin/$defaultBranch

          # Remove existing folder and copy new content
          $targetPath = "${{ vars.BCTECH_SOURCE_FOLDER }}"
          $localFolder = "${{ vars.LOCAL_FOLDER }}"
          
          if (Test-Path $targetPath) {
            Remove-Item -Recurse -Force $targetPath
          }

          # Ensure parent directory exists
          $parentPath = Split-Path $targetPath -Parent
          if ($parentPath -and -not (Test-Path $parentPath)) {
            New-Item -ItemType Directory -Path $parentPath -Force
          }

          # Copy from this repo to BCTech fork's folder
          Copy-Item -Recurse "../source-repo/$localFolder" $targetPath

          Write-Host "Files copied successfully"

      - name: Check for changes
        id: changes
        run: |
          Set-Location bctech-fork
          git add -A
          $hasChanges = (git diff --staged --name-only | Measure-Object).Count -gt 0
          if ($hasChanges) {
            "has_changes=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            Write-Host "Changes detected"
          } else {
            "has_changes=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            Write-Host "No changes detected"
          }

      - name: Commit and push to fork
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          Set-Location bctech-fork
          $commitShort = "${{ steps.commit-info.outputs.commit_short }}"
          git commit -m "Update ${{ vars.BCTECH_SOURCE_FOLDER }} ($commitShort)"
          git push origin ${{ env.SYNC_BRANCH }} --force

      - name: Create or update PR on fork
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.FORKREPOPAT }}
        run: |
          $forkRepo = "${{ vars.FORK_REPO }}"
          $commitSha = "${{ steps.commit-info.outputs.commit_sha }}"
          $commitShort = "${{ steps.commit-info.outputs.commit_short }}"
          $commitMsg = "${{ steps.commit-info.outputs.commit_msg }}"
          $repoUrl = "${{ github.server_url }}/${{ github.repository }}"
          
          # Get default branch
          Set-Location bctech-fork
          $defaultBranch = git remote show origin | Select-String "HEAD branch:" | ForEach-Object { $_.Line -replace ".*HEAD branch:\s*", "" }
          
          $prBody = @"
          ## ${{ vars.LOCAL_FOLDER }} Update
          
          This PR syncs changes from [${{ github.repository }}]($repoUrl).
          
          **Source commit:** [``$commitShort``]($repoUrl/commit/$commitSha)
          **Commit message:** $commitMsg
          
          ---
          *This PR is automatically created and updated when changes are pushed to main.*
          *To sync upstream to microsoft/BCTech, create a PR manually from this branch.*
          "@
          
          # Check if PR already exists
          $existingPr = gh pr list --repo "$forkRepo" --head "${{ env.SYNC_BRANCH }}" --json number --jq '.[0].number' 2>$null
          
          if ($existingPr) {
            Write-Host "PR #$existingPr already exists, updating..."
            gh pr edit $existingPr --repo "$forkRepo" --body $prBody
          } else {
            Write-Host "Creating new PR on fork repository"
            gh pr create --repo "$forkRepo" `
              --head "${{ env.SYNC_BRANCH }}" `
              --base "$defaultBranch" `
              --title "Update ${{ vars.LOCAL_FOLDER }}" `
              --body $prBody
          }
