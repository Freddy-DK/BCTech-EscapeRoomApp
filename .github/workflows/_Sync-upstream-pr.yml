name: Create Upstream PR to BCTech

on:
  push:
    branches:
      - test
    paths:
      - 'EscapeRoomApp/**'
  workflow_dispatch:
    # Allow manual trigger

permissions:
  contents: read

defaults:
  run:
    shell: pwsh

env:
  UPSTREAM_REPO: microsoft/BCTech
  FORK_REPO: Freddy-DK/BCTech  # Change this to your fork of BCTech
  TARGET_FOLDER: "non production apps/EscapeRoomApp"
  SYNC_BRANCH: sync-from-escaperoom-app

jobs:
  create-upstream-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4
        with:
          path: source-repo

      - name: Checkout fork of BCTech
        uses: actions/checkout@v4
        with:
          repository: ${{ env.FORK_REPO }}
          token: ${{ secrets.FORKPAT }}
          path: bctech-fork
          fetch-depth: 0

      - name: Sync fork with upstream
        run: |
          Set-Location bctech-fork
          git remote add upstream "https://github.com/${{ env.UPSTREAM_REPO }}.git"
          git fetch upstream
          git checkout -B main upstream/main
          git push origin main --force

      - name: Get commit info
        id: commit-info
        run: |
          Set-Location source-repo
          $commitSha = git rev-parse HEAD
          $commitShort = git rev-parse --short HEAD
          $commitMsg = git log -1 --pretty=%s
          "commit_sha=$commitSha" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "commit_short=$commitShort" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "commit_msg=$commitMsg" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Create branch and copy changes
        run: |
          Set-Location bctech-fork
          git checkout -B ${{ env.SYNC_BRANCH }} main

          # Remove existing folder and copy new content
          $targetPath = "${{ env.TARGET_FOLDER }}"
          if (Test-Path $targetPath) {
            Remove-Item -Recurse -Force $targetPath
          }

          # Ensure parent directory exists
          $parentPath = Split-Path $targetPath -Parent
          if (-not (Test-Path $parentPath)) {
            New-Item -ItemType Directory -Path $parentPath -Force
          }

          # Copy from this repo's EscapeRoomApp to BCTech's folder
          Copy-Item -Recurse "../source-repo/EscapeRoomApp" $targetPath

          Write-Host "Files copied successfully"

      - name: Check for changes
        id: changes
        run: |
          Set-Location bctech-fork
          git add -A
          $hasChanges = (git diff --staged --name-only | Measure-Object).Count -gt 0
          if ($hasChanges) {
            "has_changes=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            Write-Host "Changes detected"
          } else {
            "has_changes=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            Write-Host "No changes detected"
          }

      - name: Commit and push to fork
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          Set-Location bctech-fork
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          $commitShort = "${{ steps.commit-info.outputs.commit_short }}"
          git commit -m "Update EscapeRoomApp ($commitShort)"
          git push origin ${{ env.SYNC_BRANCH }} --force

      - name: Create or update PR on upstream
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GHTOKENWORKFLOW }}
        run: |
          $commitSha = "${{ steps.commit-info.outputs.commit_sha }}"
          $commitShort = "${{ steps.commit-info.outputs.commit_short }}"
          $commitMsg = "${{ steps.commit-info.outputs.commit_msg }}"
          $forkOwner = "${{ env.FORK_REPO }}".Split('/')[0]
          $repoUrl = "${{ github.server_url }}/${{ github.repository }}"
          
          $prBody = @"
          ## EscapeRoomApp Update
          
          This PR syncs changes from [${{ github.repository }}]($repoUrl).
          
          **Source commit:** [``$commitShort``]($repoUrl/commit/$commitSha)
          **Commit message:** $commitMsg
          
          ---
          *This PR is automatically created and updated when changes are pushed to main.*
          "@
          
          # Check if PR already exists
          $existingPr = gh pr list --repo "${{ env.UPSTREAM_REPO }}" --head "${forkOwner}:${{ env.SYNC_BRANCH }}" --json number --jq '.[0].number' 2>$null
          
          if ($existingPr) {
            Write-Host "PR #$existingPr already exists, updating..."
            gh pr edit $existingPr --repo "${{ env.UPSTREAM_REPO }}" --body $prBody
          } else {
            Write-Host "Creating new PR on upstream repository"
            gh pr create --repo "${{ env.UPSTREAM_REPO }}" `
              --head "${forkOwner}:${{ env.SYNC_BRANCH }}" `
              --base "main" `
              --title "Update EscapeRoomApp" `
              --body $prBody
          }
