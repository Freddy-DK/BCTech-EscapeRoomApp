name: Create Upstream PR to BCTech

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'EscapeRoomApp/**'

permissions:
  contents: read
  pull-requests: read

defaults:
  run:
    shell: pwsh

env:
  UPSTREAM_REPO: microsoft/BCTech
  FORK_REPO: Freddy-DK/BCTech  # Change this to your fork of BCTech
  TARGET_FOLDER: "non production apps/EscapeRoomApp"

jobs:
  create-upstream-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repository PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          path: source-repo

      - name: Checkout fork of BCTech
        uses: actions/checkout@v4
        with:
          repository: ${{ env.FORK_REPO }}
          token: ${{ secrets.GHTOKENWORKFLOW }}
          path: bctech-fork
          fetch-depth: 0

      - name: Sync fork with upstream
        run: |
          Set-Location bctech-fork
          git remote add upstream "https://github.com/${{ env.UPSTREAM_REPO }}.git"
          git fetch upstream
          git checkout -B main upstream/main
          git push origin main --force

      - name: Create branch and copy changes
        id: branch
        run: |
          $branchName = "escaperoom-pr-${{ github.event.pull_request.number }}"
          "branch_name=$branchName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          
          Set-Location bctech-fork
          git checkout -B $branchName main
          
          # Remove existing folder and copy new content
          $targetPath = "${{ env.TARGET_FOLDER }}"
          if (Test-Path $targetPath) {
            Remove-Item -Recurse -Force $targetPath
          }
          
          # Ensure parent directory exists
          $parentPath = Split-Path $targetPath -Parent
          if (-not (Test-Path $parentPath)) {
            New-Item -ItemType Directory -Path $parentPath -Force
          }
          
          # Copy from this repo's EscapeRoomApp to BCTech's folder
          Copy-Item -Recurse "../source-repo/EscapeRoomApp" $targetPath
          
          Write-Host "Files copied successfully"

      - name: Check for changes
        id: changes
        run: |
          Set-Location bctech-fork
          git add -A
          $hasChanges = (git diff --staged --name-only | Measure-Object).Count -gt 0
          if ($hasChanges) {
            "has_changes=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            Write-Host "Changes detected"
          } else {
            "has_changes=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            Write-Host "No changes detected"
          }

      - name: Commit and push to fork
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          Set-Location bctech-fork
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Update EscapeRoomApp from PR #${{ github.event.pull_request.number }}"
          git push origin ${{ steps.branch.outputs.branch_name }} --force

      - name: Create or update PR on upstream
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GHTOKENWORKFLOW }}
        run: |
          $branchName = "${{ steps.branch.outputs.branch_name }}"
          $prNumber = "${{ github.event.pull_request.number }}"
          $prTitle = "${{ github.event.pull_request.title }}"
          $prUrl = "${{ github.event.pull_request.html_url }}"
          $forkOwner = "${{ env.FORK_REPO }}".Split('/')[0]
          
          $prBody = @"
          ## EscapeRoomApp Update
          
          This PR was automatically created from: $prUrl
          
          **Original PR Title:** $prTitle
          
          ---
          *This PR is automatically updated when the source PR is updated.*
          "@
          
          # Check if PR already exists
          $existingPr = gh pr list --repo "${{ env.UPSTREAM_REPO }}" --head "${forkOwner}:${branchName}" --json number --jq '.[0].number' 2>$null
          
          if ($existingPr) {
            Write-Host "PR #$existingPr already exists, it will be updated with the pushed changes"
            # Update PR body
            gh pr edit $existingPr --repo "${{ env.UPSTREAM_REPO }}" --body $prBody
          } else {
            Write-Host "Creating new PR on upstream repository"
            gh pr create --repo "${{ env.UPSTREAM_REPO }}" `
              --head "${forkOwner}:${branchName}" `
              --base "main" `
              --title "Update EscapeRoomApp (from PR #$prNumber)" `
              --body $prBody
          }
